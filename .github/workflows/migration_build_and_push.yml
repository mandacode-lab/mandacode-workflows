name: Migration Build and Push

on:
  workflow_call:
    inputs:
      dockerfile-path:
        description: 'Path to Dockerfiles directory'
        required: false
        type: string
        default: 'build'
      registry:
        description: 'Docker registry'
        required: false
        type: string
        default: 'ghcr.io'
      image-prefix:
        description: 'Image name prefix'
        required: true
        type: string
    secrets:
      registry-username:
        description: 'Registry username'
        required: true
      registry-password:
        description: 'Registry password/token'
        required: true

permissions:
  actions: read
  contents: read
  packages: write

jobs:
  find-migrations:
    name: Find Migration Dockerfiles
    runs-on: ubuntu-latest
    outputs:
      migrations: ${{ steps.find.outputs.migrations }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Find migration Dockerfiles
        id: find
        run: |
          MIGRATIONS=$(find ${{ inputs.dockerfile-path }} -type f -name 'Dockerfile.migration' | jq -R -s -c 'split("\n")[:-1]')
          echo "migrations=$MIGRATIONS" >> $GITHUB_OUTPUT
          echo "Found migration Dockerfiles:"
          echo "$MIGRATIONS" | jq -r '.[]'

  build-and-push:
    name: Build and Push Migration
    runs-on: ubuntu-latest
    needs: find-migrations
    if: needs.find-migrations.outputs.migrations != '[]'
    strategy:
      matrix:
        dockerfile: ${{ fromJson(needs.find-migrations.outputs.migrations) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract service name
        id: extract
        run: |
          SERVICE=$(basename $(dirname ${{ matrix.dockerfile }}))
          echo "service=$SERVICE" >> $GITHUB_OUTPUT
          echo "Service: $SERVICE"

      - name: Get migration files path
        id: migration-path
        run: |
          SERVICE="${{ steps.extract.outputs.service }}"
          MIGRATION_DIR="services/${SERVICE}/ent/migrate/migrations"
          echo "migration-dir=$MIGRATION_DIR" >> $GITHUB_OUTPUT
          echo "Migration directory: $MIGRATION_DIR"

      - name: Read VERSION file
        id: version
        run: |
          SERVICE="${{ steps.extract.outputs.service }}"
          MIGRATION_DIR="${{ steps.migration-path.outputs.migration-dir }}"
          VERSION_FILE="${MIGRATION_DIR}/VERSION"

          if [ -f "$VERSION_FILE" ]; then
            VERSION=$(cat "$VERSION_FILE" | tr -d '[:space:]')
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Migration version: $VERSION"
          else
            echo "âŒ VERSION file not found: $VERSION_FILE"
            exit 1
          fi

      - name: Determine if version changed
        id: changed
        run: |
          SERVICE="${{ steps.extract.outputs.service }}"
          VERSION="${{ steps.version.outputs.version }}"
          IMAGE_NAME="${{ inputs.registry }}/${{ inputs.image-prefix }}/${SERVICE}-migration"

          # Check if this version already exists
          if docker manifest inspect ${IMAGE_NAME}:${VERSION} >/dev/null 2>&1; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "âœ… Version ${VERSION} already exists, skipping build"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ðŸ†• Version ${VERSION} is new, will build"
          fi

      - name: Generate image tags
        id: tags
        if: steps.changed.outputs.changed == 'true'
        run: |
          SERVICE="${{ steps.extract.outputs.service }}"
          VERSION="${{ steps.version.outputs.version }}"
          IMAGE_NAME="${{ inputs.registry }}/${{ inputs.image-prefix }}/${SERVICE}-migration"

          # Primary tag: version
          TAGS="${IMAGE_NAME}:${VERSION}"

          # Add latest tag only for stable versions (no suffix like -beta, -alpha, -rc)
          if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            TAGS="${TAGS},${IMAGE_NAME}:latest"
            echo "âœ… Stable version detected, will tag as latest"
          else
            echo "âš ï¸ Pre-release version detected (${VERSION}), latest tag will not be added"
          fi

          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "image-name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "Generated tags:"
          echo "$TAGS" | tr ',' '\n'

      - name: Login to Registry
        if: steps.changed.outputs.changed == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ secrets.registry-username }}
          password: ${{ secrets.registry-password }}

      - name: Build and push migration image
        if: steps.changed.outputs.changed == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        run: |
          SERVICE="${{ steps.extract.outputs.service }}"
          VERSION="${{ steps.version.outputs.version }}"
          IMAGE_NAME="${{ inputs.registry }}/${{ inputs.image-prefix }}/${SERVICE}-migration"
          CHANGED="${{ steps.changed.outputs.changed }}"

          echo "### ðŸ—„ï¸ Migration Image" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** $SERVICE" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`$VERSION\`" >> $GITHUB_STEP_SUMMARY

          if [ "$CHANGED" = "true" ]; then
            echo "**Status:** ðŸ†• Built and pushed new image" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.tags.outputs.tags }}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âœ… Version already exists, skipped build" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Existing image:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${IMAGE_NAME}:${VERSION}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run migration:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker run --rm -e DATABASE_URL=\"postgres://...\" ${IMAGE_NAME}:${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
