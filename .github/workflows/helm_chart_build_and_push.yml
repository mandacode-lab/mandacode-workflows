name: Helm Chart Build and Push

on:
  workflow_call:
    inputs:
      chart-path:
        description: 'Path to Helm charts directory'
        required: false
        type: string
        default: 'helm'
      helm-version:
        description: 'Helm version to use'
        required: false
        type: string
        default: 'v3.16.3'
      registry:
        description: 'OCI registry for Helm charts (e.g., ghcr.io, registry-1.docker.io)'
        required: false
        type: string
        default: 'ghcr.io'
      registry-path:
        description: 'Registry path prefix (e.g., owner/charts)'
        required: true
        type: string
      version-strategy:
        description: 'Version strategy: tag (use git tag), chart (use Chart.yaml version), auto (auto-increment)'
        required: false
        type: string
        default: 'chart'
      version-override:
        description: 'Override version (leave empty to use strategy)'
        required: false
        type: string
        default: ''
      app-version-strategy:
        description: 'App version strategy: tag (use git tag), sha (use commit sha), custom'
        required: false
        type: string
        default: 'tag'
      app-version-override:
        description: 'Override app version (leave empty to use strategy)'
        required: false
        type: string
        default: ''
      enable-signing:
        description: 'Enable chart signing with GPG'
        required: false
        type: boolean
        default: false
    secrets:
      registry-username:
        description: 'Registry username'
        required: true
      registry-password:
        description: 'Registry password/token'
        required: true
      gpg-private-key:
        description: 'GPG private key for signing (base64 encoded)'
        required: false
      gpg-passphrase:
        description: 'GPG key passphrase'
        required: false

permissions:
  actions: read
  contents: read
  packages: write

jobs:
  find-charts:
    name: Find Helm Charts
    runs-on: ubuntu-latest
    outputs:
      charts: ${{ steps.find.outputs.charts }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Find Helm charts
        id: find
        run: |
          CHARTS=$(find ${{ inputs.chart-path }} -name 'Chart.yaml' -exec dirname {} \; | jq -R -s -c 'split("\n")[:-1]')
          echo "charts=$CHARTS" >> $GITHUB_OUTPUT
          echo "Found Helm charts:"
          echo "$CHARTS" | jq -r '.[]'

  package-and-push:
    name: Package and Push
    runs-on: ubuntu-latest
    needs: find-charts
    if: needs.find-charts.outputs.charts != '[]'
    strategy:
      matrix:
        chart: ${{ fromJson(needs.find-charts.outputs.charts) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ inputs.helm-version }}

      - name: Extract chart info
        id: extract
        run: |
          CHART_NAME=$(yq eval '.name' ${{ matrix.chart }}/Chart.yaml)
          CHART_VERSION=$(yq eval '.version' ${{ matrix.chart }}/Chart.yaml)
          CHART_APP_VERSION=$(yq eval '.appVersion' ${{ matrix.chart }}/Chart.yaml)

          echo "chart-name=$CHART_NAME" >> $GITHUB_OUTPUT
          echo "chart-version=$CHART_VERSION" >> $GITHUB_OUTPUT
          echo "app-version=$CHART_APP_VERSION" >> $GITHUB_OUTPUT

      - name: Determine version
        id: version
        run: |
          # Determine chart version
          if [ -n "${{ inputs.version-override }}" ]; then
            VERSION="${{ inputs.version-override }}"
          else
            case "${{ inputs.version-strategy }}" in
              tag)
                if [ "${{ github.ref_type }}" = "tag" ]; then
                  VERSION="${{ github.ref_name }}"
                  VERSION="${VERSION#v}"  # Remove 'v' prefix if exists
                else
                  echo "Error: tag strategy requires a git tag"
                  exit 1
                fi
                ;;
              chart)
                VERSION="${{ steps.extract.outputs.chart-version }}"
                ;;
              auto)
                VERSION="${{ steps.extract.outputs.chart-version }}"
                # Auto-increment patch version
                IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
                PATCH=$((PATCH + 1))
                VERSION="${MAJOR}.${MINOR}.${PATCH}"
                ;;
            esac
          fi

          # Determine app version
          if [ -n "${{ inputs.app-version-override }}" ]; then
            APP_VERSION="${{ inputs.app-version-override }}"
          else
            case "${{ inputs.app-version-strategy }}" in
              tag)
                if [ "${{ github.ref_type }}" = "tag" ]; then
                  APP_VERSION="${{ github.ref_name }}"
                else
                  APP_VERSION="dev-$(echo ${{ github.sha }} | cut -c1-7)"
                fi
                ;;
              sha)
                APP_VERSION="sha-$(echo ${{ github.sha }} | cut -c1-7)"
                ;;
              custom)
                APP_VERSION="${{ steps.extract.outputs.app-version }}"
                ;;
            esac
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "app-version=$APP_VERSION" >> $GITHUB_OUTPUT
          echo "Chart version: $VERSION"
          echo "App version: $APP_VERSION"

      - name: Update Chart.yaml versions
        run: |
          yq eval -i '.version = "${{ steps.version.outputs.version }}"' ${{ matrix.chart }}/Chart.yaml
          yq eval -i '.appVersion = "${{ steps.version.outputs.app-version }}"' ${{ matrix.chart }}/Chart.yaml

          echo "Updated Chart.yaml:"
          cat ${{ matrix.chart }}/Chart.yaml

      - name: Setup GPG
        if: inputs.enable-signing
        run: |
          echo "${{ secrets.gpg-private-key }}" | base64 -d | gpg --import --batch --yes
          echo "GPG key imported"

      - name: Package chart
        run: |
          mkdir -p .helm-packages

          if [ "${{ inputs.enable-signing }}" = "true" ]; then
            helm package ${{ matrix.chart }} \
              --destination .helm-packages \
              --sign \
              --key "${{ secrets.gpg-key-name }}" \
              --keyring ~/.gnupg/pubring.gpg \
              --passphrase-file <(echo "${{ secrets.gpg-passphrase }}")
          else
            helm package ${{ matrix.chart }} --destination .helm-packages
          fi

          ls -la .helm-packages/

      - name: Login to OCI registry
        run: |
          echo "${{ secrets.registry-password }}" | helm registry login ${{ inputs.registry }} \
            --username ${{ secrets.registry-username }} \
            --password-stdin

      - name: Push chart to OCI registry
        run: |
          CHART_PACKAGE=$(ls .helm-packages/${{ steps.extract.outputs.chart-name }}-${{ steps.version.outputs.version }}.tgz)

          helm push "$CHART_PACKAGE" \
            oci://${{ inputs.registry }}/${{ inputs.registry-path }}

          echo "✅ Chart pushed successfully"

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: .helm-packages/${{ steps.extract.outputs.chart-name }}-${{ steps.version.outputs.version }}.tgz

      - name: Summary
        run: |
          echo "### ⎈ Helm Chart Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Chart:** ${{ steps.extract.outputs.chart-name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**App Version:** ${{ steps.version.outputs.app-version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** \`oci://${{ inputs.registry }}/${{ inputs.registry-path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Install command:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "helm install my-release oci://${{ inputs.registry }}/${{ inputs.registry-path }}/${{ steps.extract.outputs.chart-name }} --version ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
